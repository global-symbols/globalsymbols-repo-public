:ruby
  title t('views.articles.index.title')
  description t('views.articles.index.description')

  set_meta_tags og: {
    url: symbolsets_url,
    type: 'object'
  }
= render partial: 'topbar', cache: true

- if @featured_article.present?
  - featured_translations = @featured_article['translations'] || []
  - featured_current_lang = DIRECTUS_LANGUAGE_MAPPING.call[I18n.locale.to_sym] || DIRECTUS_DEFAULT_LANGUAGE.call
  - featured_requested_translation = featured_translations.find { |t| t['languages_code'] == featured_current_lang }
  - featured_fallback_translation = featured_translations.find { |t| t['languages_code'] == DIRECTUS_DEFAULT_LANGUAGE.call }
  -# Always try English as final fallback, even if default language is different
  - featured_english_translation = featured_translations.find { |t| t['languages_code'] == 'en-GB' }
  - featured_translation = featured_requested_translation || featured_fallback_translation || featured_english_translation || {}
  - featured_using_fallback = featured_requested_translation.nil? && (featured_fallback_translation.present? || featured_english_translation.present?)


  %section.featured-article-hero
    .featured-strap FEATURED
    - if @featured_article['image'] && !@featured_article['image'].empty?
      - hero_image_url = "#{DIRECTUS_URL}/assets/#{@featured_article['image']}"
      .hero-background{style: "background-image: url('#{hero_image_url}');"}
    .hero-overlay
      .container-xl
        .hero-content
          %h1.hero-title
            %a{href: article_path(@featured_article['slug']), style: "color: white; text-decoration: none;"}= featured_translation['title'] || @featured_article['slug']&.gsub('-', ' ')&.titleize || 'Featured Article'
          - if featured_using_fallback
            %small.text-warning.mb-3 (en-GB)
          .hero-meta
            - if @featured_article['author'] && @featured_article['author']['first_name']
              - author_name = [@featured_article['author']['first_name'], @featured_article['author']['last_name']].compact.join(' ')
              - if author_name.present?
                %span.hero-author By #{author_name}
            - if @featured_article['date_created']
              %span.hero-date= " • #{Date.parse(@featured_article['date_created']).strftime('%B %d, %Y')}"
          .hero-actions.mt-4
            %a.btn.btn-primary.btn-lg{href: article_path(@featured_article['slug']), 'aria-hidden' => 'true'} Read More

%main.container-xl
  %section.mt-5
    - if @directus_error
      .alert.alert-warning
        %h4 Unable to Load Articles
        %p We're currently experiencing issues connecting to our content management system. Please try again later.

    -# Category filter links
    - if @categories.present? && @categories.length > 1
      .mb-5.category-filter
        .d-flex.flex-wrap.align-items-center.mb-3
          %a.btn.btn-outline-primary.btn-sm.mb-1{href: news_path, class: @selected_category.blank? ? 'active' : '', style: "margin-right: 8px"}
            All
          - @categories.each do |category|
            - category_param = { category: category }
            - category_param[:page] = @current_page if @current_page > 1
            %a.btn.btn-outline-primary.btn-sm.mb-1{href: news_path(category_param), class: @selected_category == category ? 'active' : '', style: "margin-right: 8px"}
              = category.to_s.titleize

    .row
      - @articles.each do |article|
        -# Get the translation for the current language or fallback
        - translations = article['translations'] || []
        - current_lang_code = DIRECTUS_LANGUAGE_MAPPING.call[I18n.locale.to_sym] || DIRECTUS_DEFAULT_LANGUAGE.call
        - requested_translation = translations.find { |t| t['languages_code'] == current_lang_code }
        - fallback_translation = translations.find { |t| t['languages_code'] == DIRECTUS_DEFAULT_LANGUAGE.call }
        -# Always try English as final fallback, even if default language is different
        - english_translation = translations.find { |t| t['languages_code'] == 'en-GB' }
        - translation = requested_translation || fallback_translation || english_translation || {}
        - using_fallback = requested_translation.nil? && (fallback_translation.present? || english_translation.present?)

        -# Responsive grid: 6 articles per row on mobile (col-6), 3 per row on desktop (col-md-4)
        .col-6.col-md-4.mb-4
          .card.h-100.news-article-card
            - if article['image'] && !article['image'].empty?
              - image_url = "#{DIRECTUS_URL}/assets/#{article['image']}"
              %img.card-img-top{src: image_url, alt: translation['title'] || 'Article image', style: "max-width: 100%; height: auto;"}
            .card-body.d-flex.flex-column
              %h3.card-title{:style => "font-weight: 600"}
                %a{href: article_path(article['slug'])}= translation['title'] || 'Article Title'
                - if using_fallback
                  %small.text-warning (en-GB)
              - if translation['short_description'].present?
                %p.card-text.mb-2
                  = translation['short_description']
              %p.card-text.text-muted
                - if article['date_created']
                  = Date.parse(article['date_created']).strftime('%B %d, %Y')
              .mt-auto
                %a.btn.btn-primary{href: article_path(article['slug']), 'aria-hidden' => 'true'} Read More

      - if @articles.empty? && !@directus_error
        .col-12
          .text-center.mt-5
            %h4 No Articles Found
            %p
              - if @selected_category.present?
                = "No articles found in the '#{@selected_category.to_s.titleize}' category."
                %br
                %a{href: news_path} View all articles
              - else
                There are currently no articles to display.

    -# Pagination controls
    - if @total_pages > 1
      .d-flex.justify-content-center.mt-5
        %nav{"aria-label" => "Article pagination"}
          %ul.pagination
            - if @has_previous_page
              %li.page-item
                %a.page-link{href: news_path(category: @selected_category, page: @previous_page), "aria-label" => "Previous"}
                  %span{"aria-hidden" => "true"} ‹
                  %span.sr-only Previous
            - else
              %li.page-item.disabled
                %span.page-link
                  %span{"aria-hidden" => "true"} ‹
                  %span.sr-only Previous

            -# Page number links (show current page and a few around it)
            - start_page = [@current_page - 2, 1].max
            - end_page = [@current_page + 2, @total_pages].min

            - if start_page > 1
              %li.page-item
                %a.page-link{href: news_path(category: @selected_category, page: 1)} 1
              - if start_page > 2
                %li.page-item.disabled
                  %span.page-link …

            - (start_page..end_page).each do |page_num|
              %li.page-item{class: page_num == @current_page ? 'active' : ''}
                %a.page-link{href: news_path(category: @selected_category, page: page_num)}= page_num

            - if end_page < @total_pages
              - if end_page < @total_pages - 1
                %li.page-item.disabled
                  %span.page-link …
              %li.page-item
                %a.page-link{href: news_path(category: @selected_category, page: @total_pages)}= @total_pages

            - if @has_next_page
              %li.page-item
                %a.page-link{href: news_path(category: @selected_category, page: @next_page), "aria-label" => "Next"}
                  %span{"aria-hidden" => "true"} ›
                  %span.sr-only Next
            - else
              %li.page-item.disabled
                %span.page-link
                  %span{"aria-hidden" => "true"} ›
                  %span.sr-only Next
