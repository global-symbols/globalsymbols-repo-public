:ruby
  translation = @tap_topics_translation || {}
  page_title = translation['title'].presence || 'Tap Topics'
  page_title = "#{page_title} (DRAFT)" if @tap_topics_is_draft
  title page_title
  description 'Tap Topics boardsets'

%main.container-xl
  %section.mt-5
    %header.mb-5
      %h1.mb-4.text-center{:style => "font-weight: 600"}= page_title
      - if @tap_topics_using_fallback
        %small.text-warning.d-block.text-center.mb-3 (Displayed in en-GB)
      - if translation['content'].present?
        - content = translation['content'].to_s
        - if content.lstrip.start_with?('<')
          .mx-auto{:style => "max-width: 60rem;"}= sanitize(content)
        - else
          .mx-auto{:style => "max-width: 60rem;"}= redcarpet(NewsArticleRenderer).render(content).html_safe

    - if @directus_error
      .alert.alert-warning
        %h4 Unable to Load Boardsets
        %p We're currently experiencing issues connecting to our content management system. Please try again later.

    -# Filters
    #tap-topics-filters.mb-4
      -# Language select (Directus codes like en-GB)
      - if @languages.present?
        %form{action: tap_topics_path, method: 'get', class: 'form-inline mb-3'}
          -# Preserve current category filter
          - if @selected_category.present?
            %input{type: 'hidden', name: 'category', value: @selected_category}
          %label.mr-2{for: 'tap_topics_language'} Language
          %select.custom-select.custom-select-sm#tap_topics_language{name: 'language', onchange: 'sessionStorage.setItem("tapTopicsScrollToFilters","1"); this.form.submit();'}
            %option{value: '', selected: @selected_language.blank?} All Languages
            - @languages.each do |lang|
              - display_name = @language_name_by_code[lang].presence || lang
              %option{value: lang, selected: @selected_language == lang}= display_name

          %label.mr-2.ml-md-3{for: 'tap_topics_density'} Density
          %select.custom-select.custom-select-sm#tap_topics_density{name: 'density', onchange: 'sessionStorage.setItem("tapTopicsScrollToFilters","1"); this.form.submit();'}
            %option{value: '', selected: @selected_density.blank?} All
            %option{value: 'low', selected: @selected_density == 'low'} Low density
            %option{value: 'high', selected: @selected_density == 'high'} High density

      -# Category filter links
      - if @categories.present?
        .mb-3.category-filter
          .d-flex.flex-wrap.align-items-center.mb-2
            %a.btn.btn-outline-primary.btn-sm.mb-1{href: tap_topics_path(language: @selected_language, density: @selected_density), class: @selected_category.blank? ? 'active' : '', style: "margin-right: 8px"}
              All Categories
            - @categories.each do |category|
              %a.btn.btn-outline-primary.btn-sm.mb-1{href: tap_topics_path(category: category, language: @selected_language, density: @selected_density), class: @selected_category == category ? 'active' : '', style: "margin-right: 8px"}
                = category.to_s.titleize

    .row
      - @boardsets.each do |boardset|
        - translations = boardset['translations'] || []
        -# Display language is driven by @language_code (controller picks selected filter language, else site locale).
        - requested_translation = translations.find { |t| t.is_a?(Hash) && t['gs_languages_code'] == @language_code }
        - fallback_translation = translations.find { |t| t.is_a?(Hash) && t['gs_languages_code'] == DIRECTUS_DEFAULT_LANGUAGE.call }
        - english_translation = translations.find { |t| t.is_a?(Hash) && t['gs_languages_code'] == 'en-GB' }
        - any_translation_with_title = translations.find { |t| t.is_a?(Hash) && t['title'].present? }
        - translation = requested_translation || fallback_translation || english_translation || any_translation_with_title || {}

        - low_id = boardset['board_low']
        - high_id = boardset['board_high']
        - thumbnail_id = boardset['thumbnail']
        - low_url = low_id.present? ? "#{DIRECTUS_URL}/assets/#{low_id}" : nil
        - high_url = high_id.present? ? "#{DIRECTUS_URL}/assets/#{high_id}" : nil
        - thumbnail_url = thumbnail_id.present? ? "#{DIRECTUS_URL}/assets/#{thumbnail_id}" : nil
        - modal_title = translation['title'].presence || "Boardset ##{boardset['id']}"

        .col-6.col-md-4.col-lg-3.mb-4
          %a.card.h-100.tap-topics-card{href: '#', role: 'button', 'data-toggle' => 'modal', 'data-target' => '#tapTopicsBoardsetModal', 'data-low-url' => low_url, 'data-high-url' => high_url, 'data-title' => modal_title}
            - if thumbnail_url.present?
              %img.card-img-top{src: thumbnail_url, alt: modal_title, style: "width: 100%; height: auto; display: block;"}
            - elsif low_url.present?
              %object.card-img-top{data: low_url, type: "application/pdf", style: "width: 100%; aspect-ratio: 3 / 4; background: #fff; display: block;"}
                %p.p-2.mb-0
                  PDF preview not available.
                  %a{href: low_url, target: "_blank", rel: "noopener"} Open PDF
              %small.text-muted.p-2.d-block Preview unavailable (no thumbnail)
            .card-body.d-flex.flex-column
              %h3.card-title{:style => "font-weight: 600"}
                = modal_title

      - if @boardsets.empty? && !@directus_error
        .col-12
          .text-center.mt-5
            %h4 No Boardsets Found
            %p
              - if @selected_category.present? || @selected_language.present? || @selected_density.present?
                No boardsets match your current filters.
                %br
                %a{href: tap_topics_path} View all boardsets
              - else
                There are currently no boardsets to display.

    -# Pagination controls
    - if @total_pages.to_i > 1
      .d-flex.justify-content-center.mt-5
        %nav{"aria-label" => "Boardset pagination"}
          %ul.pagination
            - if @has_previous_page
              %li.page-item
                %a.page-link{href: tap_topics_path(category: @selected_category, language: @selected_language, density: @selected_density, page: @previous_page), "aria-label" => "Previous"}
                  %span{"aria-hidden" => "true"} ‹
                  %span.sr-only Previous
            - else
              %li.page-item.disabled
                %span.page-link
                  %span{"aria-hidden" => "true"} ‹
                  %span.sr-only Previous

            - start_page = [@current_page - 2, 1].max
            - end_page = [@current_page + 2, @total_pages].min

            - if start_page > 1
              %li.page-item
                %a.page-link{href: tap_topics_path(category: @selected_category, language: @selected_language, density: @selected_density, page: 1)} 1
              - if start_page > 2
                %li.page-item.disabled
                  %span.page-link …

            - (start_page..end_page).each do |page_num|
              %li.page-item{class: page_num == @current_page ? 'active' : ''}
                %a.page-link{href: tap_topics_path(category: @selected_category, language: @selected_language, density: @selected_density, page: page_num)}= page_num

            - if end_page < @total_pages
              - if end_page < @total_pages - 1
                %li.page-item.disabled
                  %span.page-link …
              %li.page-item
                %a.page-link{href: tap_topics_path(category: @selected_category, language: @selected_language, density: @selected_density, page: @total_pages)}= @total_pages

            - if @has_next_page
              %li.page-item
                %a.page-link{href: tap_topics_path(category: @selected_category, language: @selected_language, density: @selected_density, page: @next_page), "aria-label" => "Next"}
                  %span{"aria-hidden" => "true"} ›
                  %span.sr-only Next
            - else
              %li.page-item.disabled
                %span.page-link
                  %span{"aria-hidden" => "true"} ›
                  %span.sr-only Next

-# Modal
#tapTopicsBoardsetModal.modal.fade{tabindex: '-1', role: 'dialog', 'aria-labelledby' => 'tapTopicsBoardsetModalLabel', 'aria-hidden' => 'true'}
  .modal-dialog.modal-lg{role: 'document'}
    .modal-content
      .modal-header
        %h3.modal-title#tapTopicsBoardsetModalLabel{style: "font-weight: 400;"} Boardset
        %button.close{type: 'button', 'data-dismiss' => 'modal', 'aria-label' => 'Close'}
          %span{'aria-hidden' => 'true'} ×
      .modal-body{style: "min-height: 70vh;"}
        %object#tapTopicsBoardsetModalPdf.img-fluid{data: '', type: "application/pdf", style: "width: 100%; height: 70vh;"}
          %p.mb-0
            PDF preview not available.
            %a#tapTopicsBoardsetModalPdfLink{href: '#', target: "_blank", rel: "noopener"} Open PDF
      .modal-footer.d-flex.align-items-center.justify-content-between
        .tap-topics-quality-toggle
          .btn-group.btn-group-toggle{"data-toggle" => "buttons"}
            %label.btn.btn-outline-primary.btn-sm#tapTopicsQualityLowLabel
              %input#tapTopicsQualityLow{type: "radio", name: "tapTopicsQuality", autocomplete: "off", value: "low"}
              Low
            %label.btn.btn-outline-primary.btn-sm#tapTopicsQualityHighLabel
              %input#tapTopicsQualityHigh{type: "radio", name: "tapTopicsQuality", autocomplete: "off", value: "high"}
              High
          %small.text-muted.d-block.mt-1#tapTopicsQualityHint
        %button.btn.btn-secondary{type: 'button', 'data-dismiss' => 'modal'} Close


